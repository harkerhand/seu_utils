name: Build and Release

on:
  push:
    tags:
      - 'v*'  # åªåœ¨ tag ä»¥ 'v' å¼€å¤´æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0

jobs:
  build:
    runs-on: windows-latest  # è¿è¡Œç¯å¢ƒæ”¹ä¸º Windows

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. è®¾ç½® Rust ç¯å¢ƒ
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt  # éœ€è¦çš„è¯å¯ä»¥æ·»åŠ 

      # 3. ç¼–è¯‘é¡¹ç›® (Windows å¹³å°)
      - name: Build project
        run: cargo build --release  # ç”Ÿæˆ Windows EXE æ–‡ä»¶

      # 4. ç”Ÿæˆç©ºçš„ JSON æ–‡ä»¶
      - name: Create empty JSON files
        run: |
          echo "token: \nbatch_id: \nloginname: \npassword: " > config.yaml
          echo {} > grades_cookie.txt

      # 5. åˆ›å»º release ç›®å½•å¹¶ç§»åŠ¨æ„å»ºäº§ç‰©
      - name: Package the build
        run: |
          mkdir release
          mkdir release\resource
          copy config.yaml release\resource\
          copy grades_cookie.txt release\resource\
          Get-ChildItem -Path target\release -Filter *.exe | ForEach-Object { Copy-Item $_.FullName -Destination release\ }

      # 6. æ‰“åŒ… release ç›®å½•
      - name: Create zip archive
        run: Compress-Archive -Path release\* -DestinationPath release_windows_x64.zip

      # 7. è·å– tag message
      - name: Build Changelog
        id: build_changelog
        uses: mikepenz/release-changelog-builder-action@v5
        with:
          toTag: "v1.0"
          configurationJson: |
            {
              "template": "#{{CHANGELOG}}\n\n<details>\n<summary>Uncategorized</summary>\n\n#{{UNCATEGORIZED}}\n</details>",
              "categories": [
                {
                    "title": "## ğŸš€ Features",
                    "labels": ["feature"]
                },
                {
                    "title": "## ğŸ› Fixes",
                    "labels": ["fix"]
                },
                {
                    "title": "## ğŸ§ª Tests",
                    "labels": ["test"]
                },
                {
                    "title": "## ğŸ’¬ Other",
                    "labels": ["other"]
                },
                {
                    "title": "## ğŸ“¦ Dependencies",
                    "labels": ["dependencies"]
                }
              ]
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 8. åˆ›å»º GitHub Release
      - name: Create Release and Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: ${{ steps.build_changelog.outputs.changelog }}
          files: release_windows_x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
